<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lights Out</title>
    <link href="../Lightsout_ico.ico" rel="shortcut icon">
    <link href="style.css" rel="stylesheet">
</head>

<body>

    <button onclick="butotnClick()"><img src="back_button.png"></button>

    <!-- キャンバスとテキストを表示するためのコンテナ -->
    <div id="canvasContainer">
        <!-- テキスト要素 -->
        <p1 class="p1">残り操作回数<br><span id="rest_count"></span><br></p1>
        <p2 class="p2">回</p2>
        <!-- Canvas要素 -->
        <canvas id="myCanvas" width="700" height="700"></canvas>
    </div>

    <script>
        var rest = 20;
        const color = [
            [-1, -1, 1],
            [-1, 1, -1],
            [1, -1, -1],
        ]
        const light = {
            width: 200,
            height: 200,
            data: [],
            color: null,
            update: function () {
                this.data.forEach(brick => {
                    if (brick.color == 1) {
                        ctx.fillStyle = "#ff0000";
                    } else {
                        ctx.fillStyle = "#000000"
                    }
                    ctx.fillRect(brick.x, brick.y, brick.width, brick.height);
                    ctx.fill();
                })
            }
        }

        const init = () => {
            light.color = 0;
            for (let i = 0; i < 9; i++) {
                light.data.push({
                    x: 25 * ((i % 3) + 1) + (light.width) * (i % 3),
                    y: 25 * (Math.floor(i / 3) + 1) + (light.height) * (Math.floor(i / 3)),
                    color: color[i % 3][Math.floor(i / 3)],
                    width: light.width,
                    height: light.height,
                })
            }
            document.getElementById('rest_count').textContent = rest;
        }

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'lightblue';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.shadowColor = 'gray';
            ctx.shadowBlur = 10;
            light.update();
            window.requestAnimationFrame(loop);
        }

        function clear (){
            window.location.href = 'lightsout_clear.html?variable=' + encodeURIComponent(rest);
        }

        function game_over() {
            window.location.href = 'lightsout_fail.html?variable=' + encodeURIComponent(rest);
        }

        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');

        init();
        loop();

        function ButtonClick(event) {
            const x = event.clientX - canvas.getBoundingClientRect().left;
            const y = event.clientY - canvas.getBoundingClientRect().top;
            if (x >= 25 && x <= 225 && y >= 25 && y <= 225) {
                rest = rest - 1;
                light.data[0].color *= -1;
                light.data[1].color *= -1;
                light.data[3].color *= -1;
            }
            else if (x >= 250 && x <= 450 && y >= 25 && y <= 225) {
                rest = rest - 1;
                light.data[0].color *= -1;
                light.data[1].color *= -1;
                light.data[2].color *= -1;
                light.data[4].color *= -1;
            }
            else if (x >= 475 && x <= 675 && y >= 25 && y <= 225) {
                rest = rest - 1;
                light.data[1].color *= -1;
                light.data[2].color *= -1;
                light.data[5].color *= -1;
            }
            else if (x >= 25 && x <= 225 && y >= 250 && y <= 450) {
                rest = rest - 1;
                light.data[0].color *= -1;
                light.data[3].color *= -1;
                light.data[4].color *= -1;
                light.data[6].color *= -1;
            }
            else if (x >= 250 && x <= 450 && y >= 250 && y <= 450) {
                rest = rest - 1;
                light.data[1].color *= -1;
                light.data[3].color *= -1;
                light.data[4].color *= -1;
                light.data[5].color *= -1;
                light.data[7].color *= -1;
            }
            else if (x >= 475 && x <= 675 && y >= 250 && y <= 450) {
                rest = rest - 1;
                light.data[2].color *= -1;
                light.data[4].color *= -1;
                light.data[5].color *= -1;
                light.data[8].color *= -1;
            }
            else if (x >= 25 && x <= 225 && y >= 475 && y <= 675) {
                rest = rest - 1;
                light.data[3].color *= -1;
                light.data[6].color *= -1;
                light.data[7].color *= -1;
            }
            else if (x >= 250 && x <= 450 && y >= 475 && y <= 675) {
                rest = rest - 1;
                light.data[4].color *= -1;
                light.data[6].color *= -1;
                light.data[7].color *= -1;
                light.data[8].color *= -1;
            }
            else if (x >= 475 && x <= 675 && y >= 475 && y <= 675) {
                rest = rest - 1;
                light.data[5].color *= -1;
                light.data[7].color *= -1;
                light.data[8].color *= -1;
            }
            let total = 0;
            for (let j = 0; j < 9; j++) {
                total += light.data[j].color;
            }
            if (total === -9) clear();
            if (rest === 0) game_over();
            document.getElementById('rest_count').textContent = rest;
        }

        document.addEventListener('click', ButtonClick);

        function butotnClick() {
            window.location.href = 'lightsout_title.html';
        }
    </script>


</body>

</html>